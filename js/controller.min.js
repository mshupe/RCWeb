
ï»¿
var timerUpdateSeconds=null;var controllerNetworks=null;var UserInfo=null;var Controllers=null;var Controller=null;var networkIndex=-1;var sConfigureNetwork="your local wifi network"
var nZoneSecondsRemaining=0;var nScheduleSecondsRemaining=0;var nRefreshCountdown=0;var nRefreshRetryCount=0;var loginValidator;var registerValidator;$(function(){loginValidator=$("#frmLogin").validate();registerValidator=$("#frmRegister").validate();$('#startTime').mobiscroll().time({theme:'jqm',display:'modal',mode:'scroller'});$('#setStartTime').click(function(){$('#startTime').mobiscroll('show');return false;});$('#loginUsername').keypress(function(e){if(e.which==13){LoginClick();}});$('#loginPassword').keypress(function(e){if(e.which==13){LoginClick();}});$('#forgotUsername').keypress(function(e){if(e.which==13){RequestPasswordReset();}});$('#txtZoneName').keypress(function(e){if(e.which==13){UpdateZone();return false;}});$('#regUsername').keypress(function(e){if(e.which==13){Register();return false;}});$('#regPassword').keypress(function(e){if(e.which==13){Register();return false;}});$('#regFirstName').keypress(function(e){if(e.which==13){Register();return false;}});$('#regLastName').keypress(function(e){if(e.which==13){Register();return false;}});$('#regPhone').keypress(function(e){if(e.which==13){Register();return false;}});$('#regAddress').keypress(function(e){if(e.which==13){Register();return false;}});$('#regCity').keypress(function(e){if(e.which==13){Register();return false;}});$('#regState').keypress(function(e){if(e.which==13){Register();return false;}});$('#regZip').keypress(function(e){if(e.which==13){Register();return false;}});});function PauseOrPlay(){if(Controller.Paused==true){$("#dlgPlay").popup("open");}
else{$("#dlgPause").popup("open");}}
function SendPauseCommand(){$("#dlgPause").popup("close");SendCommand("Pause Controller","cmd=pause&dur="+$('#selPauseDuration').val(),false);}
function SendPlayCommand(){$("#dlgPlay").popup("close");SendCommand("Start Controller","cmd=unpause",false);}
var nWaitForConfiguredController=0;function RefreshControllers(){var options=''
var sNewController=$.cookie("controllerConfigured");$('#divControllerConfigured').hide();$('#divNoControllers').hide();$('#divControllersExist').hide();if(sNewController!==undefined&&sNewController!=""){var bControllerFound=false;if(Controllers!==null){for(i=0;i<Controllers.length;i++){if(Controllers[i].MACAddress==sNewController){bControllerFound=true;$.removeCookie("controllerConfigured",{path:'/'});break;}}}
if(bControllerFound==false){$('#divControllerConfigured').show();return;}}
if(Controllers===null||Controllers.length==0||Controllers[0]===null){$('#divNoControllers').show();}
else{$('#divControllersExist').show();if(Controller===null)
Controller=Controllers[0];else{var i;for(i=0;i<Controllers.length;i++){if(Controllers[i].MACAddress==Controller.MACAddress)
Controller=Controllers[i];}}
RefreshController();}}
function RefreshController(){if(Controller===null)
return;UpdateSecondsRemaining();RefreshStatus();if(Controller.Paused==true){$('#imgPause').attr("src","/Controller/images/Play.jpg");}
else{$('#imgPause').attr("src","/Controller/images/Pause.jpg");}}
function SelectController(MACAddress){for(var i=0;i<Controllers.length;i++){if(Controllers[i].MACAddress==MACAddress){Controller=Controllers[i];RefreshController();break;}}
$('#dlgSelectController').popup('close');}
function PageRunRefresh(){if(Controller===null)
return;$('#divRunSchedules').empty();var scheduleList='<ul data-role="listview" data-inset="true" data-theme="c" data-dividertheme="b"><li data-role="list-divider">Run Schedule</li>';var schedulesAdded=0;for(var i=0;i<Controller.Schedules.length;i++){if(Controller.Schedules[i].Enabled){scheduleList=scheduleList+'<li><a onclick="OpenConfirmRunScheduleDlg('+i+')">'+Controller.Schedules[i].Name+'</a></li>';schedulesAdded=schedulesAdded+1;}}
if(Controller.Schedules.length==0){scheduleList=scheduleList+'<li>No schedules exist</li>';}
else if(schedulesAdded==0){scheduleList=scheduleList+'<li>No schedules are enabled</li>';}
scheduleList=scheduleList+'</ul>';$('#divRunSchedules').append(scheduleList).trigger('create');$('#divRunZones').empty();var zoneList='<ul data-role="listview" data-inset="true" data-theme="c" data-dividertheme="b"><li data-role="list-divider">Run Zone</li>';var zonesAdded=0;zoneList=zoneList+'<li>Minutes To Water: <p></p><input type="range" id="slidRunZoneDuration" value="10" min="1" max="60" data-highlight="true" data-theme="b" data-inline="true" data-mini="true"/></li>';for(var i=0;i<Controller.Zones.length;i++){if(Controller.Zones[i].Enabled){zoneList=zoneList+'<li><a onclick="OpenConfirmRunZoneDlg('+i+')">'+Controller.Zones[i].Name+'</a></li>';zonesAdded=zonesAdded+1;}}
if(zonesAdded==0)
zoneList=zoneList+'<li>No zones are enabled</li>';zoneList=zoneList+'</ul>';$('#divRunZones').append(zoneList).trigger('create');}
function PageConfigureZoneRefresh(){if(Controller===null)
return;$('#divConfigureZones').empty();var zoneList='<ul data-role="listview" data-inset="true" data-theme="c" data-dividertheme="b">';if(Controller.Status=='Online')
zoneList=zoneList+'<li data-role="list-divider">'+Controller.Name+'</li>';else
zoneList=zoneList+'<li data-role="list-divider">'+Controller.Name+' - '+Controller.Status+'</li>';var zonesAdded=0;for(var i=0;i<Controller.Zones.length;i++){zoneList=zoneList+'<li><a onclick="ZoneSelected('+i.toString()+')" ';if(Controller.Zones[i].Enabled)
zoneList=zoneList+'>'+Controller.Zones[i].Name+'</a></li>';else
zoneList=zoneList+'style="color: #C0C0C0" >'+Controller.Zones[i].Name+'</a></li>';zonesAdded=zonesAdded+1;}
if(zonesAdded==0)
zoneList=zoneList+'<li>No zones exist</li>';zoneList=zoneList+'</ul>';$('#divConfigureZones').append(zoneList).trigger('create');}
function PageConfigureScheduleRefresh(){if(Controller===null)
return;$('#divConfigureSchedules').empty();var scheduleList;if(Controller.Schedules===null||Controller.Schedules.length<10){scheduleList='<div id="divAddSchedule"><a data-role="button" data-inline="true" data-theme="b" onclick="AddSchedule()" data-icon="add">Add</a></div>';}
scheduleList=scheduleList+'<ul data-role="listview" data-inset="true" data-theme="c" data-dividertheme="b">';if(Controller.Status=='Online')
scheduleList=scheduleList+'<li data-role="list-divider">'+Controller.Name+'</li>';else
scheduleList=scheduleList+'<li data-role="list-divider">'+Controller.Name+' - '+Controller.Status+'</li>';var schedulesAdded=0;for(var i=0;i<Controller.Schedules.length;i++){scheduleList=scheduleList+'<li><a onclick="ScheduleSelectedOffset('+i.toString()+')" '
if(Controller.Schedules[i].Enabled)
scheduleList=scheduleList+'>'+Controller.Schedules[i].Name+'</a></li>';else
scheduleList=scheduleList+' style="color: #C0C0C0" >'+Controller.Schedules[i].Name+'</a></li>';schedulesAdded=schedulesAdded+1;}
if(schedulesAdded==0)
scheduleList=scheduleList+'<li>No schedules exist</li>';scheduleList=scheduleList+'</ul>';$('#divConfigureSchedules').append(scheduleList).trigger('create');}
function PageScheduleHistoryRefresh(){if(Controller===null)
return;$('#divScheduleHistory').empty();var scheduleHistory;var currentStartDate='';scheduleHistory='<ul data-role="listview" data-inset="true" data-theme="c" data-dividertheme="b">';scheduleHistory=scheduleHistory+'<li data-role="list-divider">'+Controller.Name+'</li>';for(var i=0;Controller.ScheduleHistory!==null&&i<Controller.ScheduleHistory.length;i++){if(currentStartDate!=Controller.ScheduleHistory[i].LocalStartDate){currentStartDate=Controller.ScheduleHistory[i].LocalStartDate;scheduleHistory=scheduleHistory+'<li data-role="list-divider">'+Controller.ScheduleHistory[i].LocalStartDate+'</li>';}
scheduleHistory=scheduleHistory+'<li><h2>'+Controller.ScheduleHistory[i].Name+'</h2>';scheduleHistory=scheduleHistory+'<p><strong>Start Time: - ';scheduleHistory=scheduleHistory+Controller.ScheduleHistory[i].LocalStartTime+'</strong></p>';scheduleHistory=scheduleHistory+'<p><strong>Duration: - ';scheduleHistory=scheduleHistory+Controller.ScheduleHistory[i].Duration+' Minutes</strong></p></li>';scheduleHistory=scheduleHistory+'';}
if(Controller.ScheduleHistory===null||Controller.ScheduleHistory.length==0)
scheduleHistory=scheduleHistory+'<li>No history exists</li>';scheduleHistory=scheduleHistory+'</ul>';$('#divScheduleHistory').append(scheduleHistory).trigger('create');}
function PageScheduleDetailRefresh(){}
function ZoneSelected(index){$('#txtZoneNumber').val(Controller.Zones[index].Number);$('#txtZoneName').val(Controller.Zones[index].Name);if(Controller.Zones[index].Enabled.toString()=="true")
$('#cbZoneEnabled').attr('checked',true).checkboxradio("refresh");else
$('#cbZoneEnabled').attr('checked',false).checkboxradio("refresh");$("#dlgZone").popup("open");return;}
function UpdateZone(){var nZoneNumber=$('#txtZoneNumber').val();var sZoneName=$('#txtZoneName').val();var bEnabled=$('#cbZoneEnabled').prop('checked');var nEnabled=0;Controller.Zones[nZoneNumber-1].Name=sZoneName;Controller.Zones[nZoneNumber-1].Enabled=bEnabled;if(bEnabled)
nEnabled=1;SendCommand("Update Zone - "+sZoneName,"cmd=updateZone&num="+nZoneNumber.toString()+"&name="+encodeURIComponent(sZoneName)+"&enabled="+nEnabled.toString(),false);PageConfigureZoneRefresh();$("#dlgZone").popup("close");}
function OpenForgotPasswordDlg(){ResetPasswordRequest=1;$('#dlgLogin').popup('close');}
function OpenConfirmRunZoneDlg(ZoneOffset){$('#divConfirmZoneContent').empty();var nDuration=$('#slidRunZoneDuration').val();var zoneInfo;if(nDuration==1)
zoneInfo='<div>Run Zone "'+Controller.Zones[ZoneOffset].Name+'" for '+nDuration.toString()+' minute?</div>';else
zoneInfo='<div>Run Zone "'+Controller.Zones[ZoneOffset].Name+'" for '+nDuration.toString()+' minutes?</div>';var sCommand='cmd=startZone&num='+Controller.Zones[ZoneOffset].Number+'&dur='+nDuration.toString();zoneInfo=zoneInfo+'<a data-role="button" data-inline="true" data-theme="b" data-rel="back" onclick="SendCommand(\'Start Zone - '+Controller.Zones[ZoneOffset].Name+'\', \''+sCommand+'\', true)">Yes</a>';zoneInfo=zoneInfo+'<a data-role="button" data-inline="true" data-theme="b" data-rel="back">No</a>';$('#divConfirmZoneContent').append(zoneInfo).trigger('create');$('#confirmRunZone').popup('open');}
function OpenConfirmRunScheduleDlg(ScheduleOffset){$('#divConfirmScheduleContent').empty();var sCommand='cmd=startSchedule&num='+Controller.Schedules[ScheduleOffset].Number.toString();var scheduleInfo='<div>Run Schedule "'+Controller.Schedules[ScheduleOffset].Name+'?</div>';scheduleInfo=scheduleInfo+'<a data-role="button" data-inline="true" data-theme="b" data-rel="back" onclick="SendCommand(\'Start Schedule - '+Controller.Schedules[ScheduleOffset].Name+'\', \''+sCommand+'\', true)">Yes</a>';scheduleInfo=scheduleInfo+'<a data-role="button" data-inline="true" data-theme="b" data-rel="back">No</a>';$('#divConfirmScheduleContent').append(scheduleInfo).trigger('create');$('#confirmRunSchedule').popup('open');}
function RefreshAccountInfo(){var user=$.cookie("savedUser");$('#lblCurrentUser').html(user);$('#lblNameOnAccount').html(UserInfo.FirstName+' '+UserInfo.LastName);$('#lblPhone').html(UserInfo.Phone);$('#lblAccountAddress').html(GetAddressHTML(UserInfo));}
function ControllerChanged(){RefreshController();}
function OpenSelectControllerDlg(){$('#dlgSelectController').empty();var controllerList='<ul id="lvSelectController" data-role="listview" data-inset="true" data-theme="c" data-dividertheme="b">';for(var i=0;i<Controllers.length;i++){controllerList=controllerList+'<li><a onclick="SelectController(\''+Controllers[i].MACAddress+'\');">'+Controllers[i].Name+' - '+Controllers[i].MACAddress+'</a></li>';}
$('#dlgSelectController').append(controllerList).trigger('create');$('#dlgSelectController').popup('open',{y:200,positionTo:'origin'});}
function RefreshStatus(){$('#lvStatus').empty();var statusHTML='';if(Controllers===null||Controller===null)
return;var listHeader;if(Controller.Status=='Online')
listHeader='<li data-role="list-divider" class="rcLIHeader">'+Controller.Name+'</li>';else
listHeader='<li data-role="list-divider" class="rcLIHeader">'+Controller.Name+' - '+Controller.Status+'</li>';if(Controllers.length>1){if(Controller.Status=='Online'){listHeader='<li data-role="list-divider" class="rcLIHeader"><fieldset class="ui-grid-a"><div class="ui-block-a" style="margin: 0.5em 0.5em 0 0; width: 200px" >'+
Controller.Name+'</div><div class="ui-block-b" style="width:50px; margin: 0.2em 0 0.5em 0;" ><button data-mini="true" onclick="OpenSelectControllerDlg()" >...</button></div></fieldset></li>';}
else{listHeader='<li data-role="list-divider" class="rcLIHeader"><fieldset class="ui-grid-a"><div class="ui-block-a" style="margin: 0.5em 0.5em 0 0; width: 200px" >'+
Controller.Name+' - '+Controller.Status+'</div><div class="ui-block-b" style="width:50px; margin: 0.2em 0 0.5em 0;" ><button data-mini="true" onclick="OpenSelectControllerDlg()" >...</button></div></fieldset></li>';}}
$("#lvStatus").append(listHeader).trigger('create');if(Controller.Status=="Offline"){statusHTML+='<li><h3>This controller has lost connectivity with our server<h3/>';statusHTML+='<p style="text-align: left; font-size: small;padding-left: 30px;">Click <a href="http://www.raincommander.com/Controller/configure.htm">here</a> to reconnect</p></li>';}
else{if(Controller.Paused==true){statusHTML+='<li><fieldset class="ui-grid-a"><div class="ui-block-a"><h3>Controller Paused Until<h3/>';statusHTML+='<p>&nbsp;&nbsp;&nbsp;<strong>'+PausedUntilTime().toLocaleString()+'</strong></p></div>';statusHTML+='<div class="ui-block-b"><a id="bPlay" onclick="PauseOrPlay()" data-role="button" style="width: 120px">Resume</a></div></fieldset></li>'}
if(nScheduleSecondsRemaining>0||nZoneSecondsRemaining>0){if(nScheduleSecondsRemaining>0){var liString='<li><fieldset class="ui-grid-a"><div class="ui-block-a"><h3>Running Schedule<h3/>';liString+='<p>&nbsp;&nbsp;&nbsp;<strong>'+Controller.LastScheduleRun+'</strong></p>';liString+='<p>&nbsp;&nbsp;&nbsp;<strong>Time Remaining '+GetTimeString(nScheduleSecondsRemaining)+'</strong></p></div>';liString+='<div class="ui-block-b"><a href="#" data-role="button" data-theme="none" data-corners="false" data-shadow="false" data-inline="true" onclick="SendCommand(\'Stop Schedule - '+Controller.LastScheduleRun+'\', \'cmd=stop\', true)"><img id="imgStopZone" src="/Controller/images/StopHand.png" alt="Stop" style="width: 50px; height: 50px" /></a></div></fieldset></li>';var $li=$(liString);$li.find('#stopCmd').buttonMarkup({icon:"delete"});$("#lvStatus").append($li);}
if(nZoneSecondsRemaining>0){var liString='<li><fieldset class="ui-grid-a"><div class="ui-block-a"><h3>Running Zone<h3/>';liString+='<p>&nbsp;&nbsp;&nbsp;<strong>'+Controller.LastZoneRun+'</strong></p>';liString+='<p>&nbsp;&nbsp;&nbsp;<strong>Time Remaining '+GetTimeString(nZoneSecondsRemaining)+'</strong></p></div>';if(nScheduleSecondsRemaining>0){liString+='<div class="ui-block-b"></div></fieldset></li>';var $li=$(liString);$("#lvStatus").append($li);}
else{liString+='<div class="ui-block-b"><a href="#" data-role="button" data-theme="none" data-corners="false" data-shadow="false" data-inline="true" onclick="SendCommand(\'Stop Zone - '+Controller.LastZoneRun+'\', \'cmd=stop\', true)"><img id="imgStopZone" src="/Controller/images/StopHand.png" alt="Stop" style="width: 50px; height: 50px" /></a></div></fieldset></li>';var $li=$(liString);$li.find('#stopCmd').buttonMarkup({icon:"delete"});$("#lvStatus").append($li);}}
else if(nZoneSecondsRemaining<0){statusHTML+='<li><h3>Last Zone Run<h3/>';statusHTML+='<p>&nbsp;&nbsp;&nbsp;<strong>'+Controller.LastZoneRun+'</strong></p>';statusHTML+='<p>&nbsp;&nbsp;&nbsp;<strong>Waiting for next zone to start</strong></p></li>';}}
else{var controllerTime;if(Controller.Paused==true){controllerTime=PausedUntilTime();}
else{controllerTime=ControllerTime();}
var NextSchedule=null;var NextScheduleRunDate=null;for(var i=0;i<Controller.Schedules.length;i++){var schedule=Controller.Schedules[i];if(schedule.Enabled==true){var NextRunDate=GetDateFromStartTime(controllerTime,schedule.LocalStartTime);if(NextRunDate<controllerTime){NextRunDate=new Date(NextRunDate.getFullYear(),NextRunDate.getMonth(),NextRunDate.getDate()+1,NextRunDate.getHours(),NextRunDate.getMinutes());}
var nDay=NextRunDate.getDay();if(schedule.ScheduleType==1&&nDay%2!=1)
NextRunDate=new Date(NextRunDate.getFullYear(),NextRunDate.getMonth(),NextRunDate.getDate()+1,NextRunDate.getHours(),NextRunDate.getMinutes());else if(schedule.ScheduleType==2&&nDay%2!=0)
NextRunDate=new Date(NextRunDate.getFullYear(),NextRunDate.getMonth(),NextRunDate.getDate()+1,NextRunDate.getHours(),NextRunDate.getMinutes());else if(schedule.ScheduleType==4){for(var nCustomDay=0;nCustomDay<7;nCustomDay++){var nCustomOffset=(nCustomDay+nDay)%7;if(schedule.CustomDays[nCustomOffset]==1)
break;NextRunDate=new Date(NextRunDate.getFullYear(),NextRunDate.getMonth(),NextRunDate.getDate()+1,NextRunDate.getHours(),NextRunDate.getMinutes());}}
if(NextScheduleRunDate===null||NextScheduleRunDate>NextRunDate){NextSchedule=schedule;NextScheduleRunDate=NextRunDate;}}}
if(NextSchedule!==null){statusHTML+='<li><fieldset class="ui-grid-a"><div class="ui-block-a"><h3>Next Schedule<h3/>';statusHTML+='<p>&nbsp;&nbsp;&nbsp;<strong>'+NextSchedule.Name+'</strong></p>';statusHTML+='<p>&nbsp;&nbsp;&nbsp;<strong>'+NextScheduleRunDate.toLocaleString()+'</strong></p></div>';if(Controller.Paused==false){statusHTML+='<div class="ui-block-b"><a id="bPause" onclick="PauseOrPlay()" data-role="button" style="width: 100px">Pause</a></div></fieldset></li>'}
else{statusHTML+='<div class="ui-block-b"></div></fieldset></li>'}}
else{statusHTML+='<li><h3>Next Schedule<h3/>';statusHTML+='<p>&nbsp;&nbsp;&nbsp;<strong>'+'No Schedule Found'+'</strong></p></li>';}}}
if(Controller.CommandStatus!=''){if(Controller.CommandStatus=="PENDING"||Controller.CommandStatus=="SENT"){statusHTML+='<li><div class="ui-grid-a"><div class="ui-block-a"><h3>Last Activity<h3/>';statusHTML+='<p>&nbsp;&nbsp;&nbsp;<strong>'+Controller.CommandDescription+' </strong> ('+Controller.CommandStatus+')</p></div>';statusHTML+='<div class="ui-block-b"><img src="/Controller/images/refresh.gif" style="width: 32px; height: 32px; padding-left: 100px; padding-top: 25px;" /></div></div></li>';}
else{statusHTML+='<li><h3>Last Activity<h3/>';statusHTML+='<p>&nbsp;&nbsp;&nbsp;<strong>'+Controller.CommandDescription+' </strong> ('+Controller.CommandStatus+')</p></li>';}}
if(statusHTML!="")
$('#lvStatus').append(statusHTML).trigger('create');if($('#lvStatus').hasClass('ui-listview')){$('#lvStatus').listview('refresh');}else{$('#lvStatus').trigger('create');}}
function ControllerTime(){var d=new Date();var utc=d.getTime()+(d.getTimezoneOffset()*60000);var controllerDate=new Date(utc+(60000*Controller.TimeZoneOffset));return controllerDate;}
function PausedUntilTime(){var d=new Date(Controller.utcSecPausedUntil*1000);var utc=d.getTime()+(d.getTimezoneOffset()*60000);var pausedUntilDate=new Date(utc+(60000*Controller.TimeZoneOffset));return pausedUntilDate;}
function GetDateFromStartTime(d,startTime){var dStartTime=new Date(d);dStartTime.setSeconds(0);dStartTime.setMilliseconds(0);var h=parseInt(startTime.substring(0,2));if(startTime.substring(6,8)=="PM"&&h<12)
h+=12;dStartTime.setHours(h);var m=parseInt(startTime.substring(3,5));dStartTime.setMinutes(m);return dStartTime;}
function GetTimeString(sec){var secDate=new Date(sec*1000)
var minutes=secDate.getMinutes();var seconds=secDate.getSeconds();var strMinutes="00";if(parseInt(minutes)<10&&minutes.toString().length<2)
strMinutes="0"+minutes;else
strMinutes=minutes;var strSeconds="00";if(parseInt(seconds)<10&&seconds.toString().length<2)
strSeconds="0"+seconds;else
strSeconds=seconds;return strMinutes+":"+strSeconds;}
function UpdateSecondsRemaining(){nScheduleSecondsRemaining=0;nZoneSecondsRemaining=0;if(Controller===null||Controller.Status=="Offline")
return;var d=new Date();var utcSec=new Date().getTime()/1000;if(Controller.utcSecLastScheduleRunOn>0&&Controller.LastScheduleDuration>0)
nScheduleSecondsRemaining=Controller.utcSecLastScheduleRunOn+(Controller.LastScheduleDuration*60)-utcSec;if(Controller.utcSecLastZoneRunOn>0&&Controller.LastZoneDuration>0)
nZoneSecondsRemaining=Controller.utcSecLastZoneRunOn+(Controller.LastZoneDuration*60)-utcSec;}
function UpdateController(){var sName=$('#txtControllerName').val();var sTimeZoneName=$('#selTimeZone').val();var observeDST="1";var tzo="-420";if(sTimeZoneName=="Pacific"){tzo="-480";}
else if(sTimeZoneName=="Arizona"){observeDST="0";tzo="-420";}
else if(sTimeZoneName=="Mountain"){tzo="-420";}
else if(sTimeZoneName=="Central"){tzo="-360";}
else if(sTimeZoneName=="Eastern"){tzo="-300";}
var cmd="cmd=updateController&name="+encodeURIComponent(sName)+"&tzn="+sTimeZoneName+"&tzo="+tzo+"&odst="+observeDST;SendCommand("Update Controller",cmd,false);}
function AddSchedule(){$.mobile.changePage("#pageScheduleDetail");var nNextScheduleNumber;var bScheduleAvailable=0;for(nNextScheduleNumber=1;nNextScheduleNumber<=10;nNextScheduleNumber++){bScheduleAvailable=1;var nCurrentSchedule;for(nCurrentSchedule=0;nCurrentSchedule<Controller.Schedules.length;nCurrentSchedule++){if(Controller.Schedules[nCurrentSchedule].Number==nNextScheduleNumber){bScheduleAvailable=0;break;}}
if(bScheduleAvailable==1)
break;}
if(bScheduleAvailable==0){alert("The max number of schedules is 10");return;}
var newSchedule=new Object();newSchedule.Number=nNextScheduleNumber;newSchedule.Name="New Schedule";newSchedule.LocalStartTime="8:00 AM";newSchedule.Enabled=true;newSchedule.ScheduleType=4;newSchedule.CustomDays="1010101";newSchedule.ZonesAndDuration="1:10~2:10~3:10~4:10~5:10~6:10~7:10~8:10~9:10~10:10~11:10~12:10"
ScheduleSelected(newSchedule);}
function ScheduleSelectedOffset(nOffset){ScheduleSelected(Controller.Schedules[nOffset]);}
function ScheduleSelected(schedule){$.mobile.changePage("#pageScheduleDetail");$('#txtScheduleNumber').val(schedule.Number);$('#txtScheduleName').val(schedule.Name);if(schedule.Enabled.toString()=="true")
$('#cbScheduleEnabled').attr('checked',true).checkboxradio("refresh");else
$('#cbScheduleEnabled').attr('checked',false).checkboxradio("refresh");$('#startTime').val(schedule.LocalStartTime);$('#selectScheduleType').val(schedule.ScheduleType);$('#selectScheduleType').selectmenu('refresh');if(schedule.ScheduleType==4)
$('#divCustomDays').show();else
$('#divCustomDays').hide();var CustomDays=[];if(schedule.CustomDays[0]==1)
CustomDays.push("Su");if(schedule.CustomDays[1]==1)
CustomDays.push("Mo");if(schedule.CustomDays[2]==1)
CustomDays.push("Tu");if(schedule.CustomDays[3]==1)
CustomDays.push("We");if(schedule.CustomDays[4]==1)
CustomDays.push("Th");if(schedule.CustomDays[5]==1)
CustomDays.push("Fr");if(schedule.CustomDays[6]==1)
CustomDays.push("Sa");$('#selectCustomDays').val(CustomDays);$('#selectCustomDays').selectmenu('refresh');$('#divScheduleDetailZoneDuration').empty();var zoneInfo='<h3>Minutes to water:</h3>';var zonesAdded=0;var durationArray=new Array();for(var i=0;i<12;i++){durationArray[i]=0;}
var sZonesAndDuration=schedule.ZonesAndDuration;var saZDs=sZonesAndDuration.split("~");for(var i in saZDs){var sZD=saZDs[i];var saZD=sZD.split(":");if(saZD.length==2){durationArray[saZD[0]-1]=saZD[1];}}
for(var i=0;Controller&&i<Controller.Zones.length;i++){var nZoneNumber=i+1;if(Controller.Zones[i].Enabled){zoneInfo=zoneInfo+'<label for="slidDuration'+nZoneNumber.toString()+'" id="lblSlidDuration'+nZoneNumber+'">'+Controller.Zones[i].Name+':</label>';zoneInfo=zoneInfo+'<input type="range" name="slidDuration'+nZoneNumber.toString()+'" id="slidDuration'+nZoneNumber.toString()+'" value="'+durationArray[i]+'" min="0" max="60" data-highlight="true" data-theme="b" data-mini="true" />';zonesAdded=zonesAdded+1;}}
if(zonesAdded==0)
zoneInfo=zoneInfo+'<h4>No zones are enabled</h4>';$('#divScheduleDetailZoneDuration').append(zoneInfo).trigger('create');$("#selectScheduleType").change(OnScheduleTypeChange);return;}
function OnScheduleTypeChange(){if($('#selectScheduleType').val()==4){$('#divCustomDays').show();}
else{$('#divCustomDays').hide();}}
function UpdateSchedule(){var nScheduleNumber=$('#txtScheduleNumber').val();var sScheduleName=$('#txtScheduleName').val();var startTime=$('#startTime').val();var bEnabled=$('#cbScheduleEnabled').prop('checked');if(nScheduleNumber<1||nScheduleNumber>=10){alert("Invalid Schedule Number: "+nScheduleNumber);return;}
if(startTime.length<7){alert("Please enter a start time")
return;}
var Schedule;var nOffset;var bFound=0;for(nOffset=0;nOffset<Controller.Schedules.length;nOffset++){if(Controller.Schedules[nOffset].Number==nScheduleNumber){bFound=1;Schedule=Controller.Schedules[nOffset];break;}}
if(bFound==0){var Schedule=new Object();var nNextSchedule=Controller.Schedules.length;Controller.Schedules[nNextSchedule]=Schedule;Schedule.Number=nScheduleNumber;}
Schedule.Name=sScheduleName;Schedule.Enabled=bEnabled;Schedule.LocalStartTime=startTime;Schedule.ScheduleType=$('#selectScheduleType').val();var sSu="0",sMo="0",sTu="0",sWe="0",sTh="0",sFr="0",sSa="0";if(Schedule.ScheduleType==4){var SelectedCustomDays=$('#selectCustomDays').val();for(var nCustomIndex=0;nCustomIndex<SelectedCustomDays.length;nCustomIndex++){if(SelectedCustomDays[nCustomIndex]=="Su")
sSu="1";else if(SelectedCustomDays[nCustomIndex]=="Mo")
sMo="1";else if(SelectedCustomDays[nCustomIndex]=="Tu")
sTu="1";else if(SelectedCustomDays[nCustomIndex]=="We")
sWe="1";else if(SelectedCustomDays[nCustomIndex]=="Th")
sTh="1";else if(SelectedCustomDays[nCustomIndex]=="Fr")
sFr="1";else if(SelectedCustomDays[nCustomIndex]=="Sa")
sSa="1";}}
Schedule.CustomDays=sSu+sMo+sTu+sWe+sTh+sFr+sSa;var sZonesAndDuration="";for(var index=0;index<12;index++){if($('#slidDuration'+(index+1).toString()).val()>0){if(sZonesAndDuration=="")
sZonesAndDuration=(index+1).toString()+":"+$('#slidDuration'+(index+1).toString()).val();else
sZonesAndDuration+="~"+(index+1).toString()+":"+$('#slidDuration'+(index+1).toString()).val();}}
Schedule.ZonesAndDuration=sZonesAndDuration;var sCMD="cmd=updateSchedule&num="+Schedule.Number.toString()+"&name="+encodeURIComponent(Schedule.Name)+"&enabled=";if(Schedule.Enabled)
sCMD+="1";else
sCMD+="0";var nHours=0;var nMinutes=0;nHours=parseInt(startTime.substring(0,2));nMinutes=parseInt(startTime.substring(3,6));if(startTime.substring(6,8)=="PM"&&nHours<12)
nHours+=12;var nLocalStartTime=nHours*60+nMinutes;sCMD+="&start="+nLocalStartTime.toString();sCMD+="&type="+Schedule.ScheduleType.toString();sCMD+="&days="+Schedule.CustomDays;sCMD+="&zd="+Schedule.ZonesAndDuration;SendCommand("Update Schedule - "+Schedule.Name,sCMD,false);PageConfigureScheduleRefresh();$.mobile.changePage("#pageConfigureSchedules");}
function MainPageSecondTimer(){if(nScheduleSecondsRemaining>0||nZoneSecondsRemaining>0){UpdateSecondsRemaining();RefreshStatus();if(nScheduleSecondsRemaining>0&&nZoneSecondsRemaining>-4&&nZoneSecondsRemaining<-2)
RefreshData(false);}
if(nRefreshCountdown==0&&nRefreshRetryCount>0){if(Controller.CommandStatus=="RECEIVED"){nRefreshRetryCount=0;}
else{nRefreshCountdown=5;nRefreshRetryCount=nRefreshRetryCount-1;}}
if(nRefreshCountdown>0){nRefreshCountdown=nRefreshCountdown-1;if(nRefreshCountdown==0){RefreshData(false);}}}
function Logout(){$('#loginUsername').val("");$('#loginPassword').val("");$.removeCookie("savedUser",{path:'/'});$.removeCookie("savedPassword",{path:'/'});$.removeCookie("controllerConfigured",{path:'/'});$("#selZone").html("");$("#selSchedule").html("");}
function LoginClick(){$('#lblLoginError').html('');ResetPasswordRequest=0;$('#dlgForgotPassword').popup('close');var txtUser=$('#loginUsername'),txtPassword=$('#loginPassword');if(txtUser.val()==''||txtPassword.val()=='')
$('#lblLoginError').html('Please enter a valid user and password');else if(txtUser.hasClass('error')||txtPassword.hasClass('error'))
$('#lblLoginError').html('Please fix errors and try again');else{Login(txtUser.val(),txtPassword.val(),"Loging In...");return true;}
return false;}
function Login(sNewUser,sNewPassword,sMessage){$.mobile.loading('show',{text:sMessage,textVisible:true,theme:"a"||$.mobile.loader.prototype.options.theme,textonly:false,html:""});var url="/Controller/wsCmd.asmx/ValidUser"+'?nocache='+new Date().getTime();$.ajax({url:url,cache:false,type:"POST",dataType:"json",data:"{_Email:'"+sNewUser+"', _Password:'"+sNewPassword+"'}",contentType:"application/json; charset=utf-8",success:function(msg){$.mobile.loading('hide');if(msg.d.ReturnCode==1){$.cookie("savedUser",sNewUser,{expires:10000,path:'/'});$.cookie("savedPassword",sNewPassword,{expires:10000,path:'/'});Controllers=msg.d.Data.Controllers;UserInfo=msg.d.Data;RefreshControllers();$.mobile.changePage("#pageMain");}
else{$('#lblLoginError').html("Error: "+msg.d.Status);$.removeCookie("savedUser",{path:'/'});$.removeCookie("savedPassword",{path:'/'});}},error:function(e){$.mobile.loading('hide');$('#lblLoginError').html("Error: "+e.statusText.toString());return false;}});}
function RequestPasswordReset(){var sResetUser=$('#forgotUsername').val();if(sResetUser==''){$('#lblForgotPasswordError').html('Please enter a valid user');return;}
$.mobile.loading('show',{text:"Requesting password reset...",textVisible:true,theme:"a"||$.mobile.loader.prototype.options.theme,textonly:false,html:""});$.ajax({url:"/Controller/wsCmd.asmx/RequestPasswordReset",cache:false,type:"POST",dataType:"json",data:"{_Email:'"+sResetUser+"'}",contentType:"application/json; charset=utf-8",success:function(msg){$.mobile.loading('hide');if(msg.d.ReturnCode==1){$('#forgotUsername').textinput('disable');$('#requestButton').addClass('ui-disabled');$('#lblForgotPasswordError').html(msg.d.Status);}
else{$('#lblForgotPasswordError').html("Error: "+msg.d.Status);}},error:function(e){$.mobile.loading('hide');$('#lblForgotPasswordError').val="Error: "+e.statusText.toString();return false;}});}
function OpenEditContactDlg(){$("#dlgEditContact").popup("open");}
function SaveContact(){$.mobile.loading('show',{text:"Saving Contact...",textVisible:true,theme:"a"||$.mobile.loader.prototype.options.theme,textonly:false,html:""});var sFirstName=$('#editFirstName').val();var sLastName=$('#editLastName').val();var sPhone=$('#editPhone').val();var user=$.cookie("savedUser");var password=$.cookie("savedPassword");$.ajax({url:"/Controller/wsCmd.asmx/SaveContact",cache:false,type:"POST",dataType:"json",data:"{_Email:'"+user+"', _Password:'"+password+"', _FirstName:'"+sFirstName+"', _LastName:'"+sLastName+"', _Phone:'"+sPhone+"'}",contentType:"application/json; charset=utf-8",success:function(msg){$.mobile.loading('hide');if(msg.d.ReturnCode==1){$("#dlgEditContact").popup("close");UserInfo.FirstName=sFirstName;UserInfo.LastName=sLastName;UserInfo.Phone=sPhone;RefreshAccountInfo();}
else{$('#lblEditContactError').html("Error: "+msg.d.Status);}},error:function(e){$.mobile.loading('hide');$('#lblEditContactError').html("Error: "+e.statusText.toString());return false;}});}
function OpenEditAccountAddress(){$("#dlgEditAccountAddress").popup("open");}
function SaveAccountAddress(){$.mobile.loading('show',{text:"Saving Address...",textVisible:true,theme:"a"||$.mobile.loader.prototype.options.theme,textonly:false,html:""});var user=$.cookie("savedUser");var password=$.cookie("savedPassword");var sAddress=$('#editAddress').val();var sCity=$('#editCity').val();var sState=$('#editState').val();var sZip=$('#editZip').val();$.ajax({url:"/Controller/wsCmd.asmx/SaveAddress",cache:false,type:"POST",dataType:"json",data:"{_Email:'"+user+"', _Password:'"+password+"', _Address:'"+sAddress+"', _City:'"+sCity+"', _State:'"+sState+"', _Zip:'"+sZip+"'}",contentType:"application/json; charset=utf-8",success:function(msg){$.mobile.loading('hide');if(msg.d.ReturnCode==1){$("#dlgEditAccountAddress").popup("close");UserInfo.Address=sAddress;UserInfo.City=sCity;UserInfo.State=sState;UserInfo.Zip=sZip;RefreshAccountInfo();}
else{$('#lblEditAccountAddressError').html("Error: "+msg.d.Status);}},error:function(e){$.mobile.loading('hide');$('#lblEditAccountAddressError').val="Error: "+e.statusText.toString();return false;}});}
function OpenChangePasswordDlg(){$("#dlgChangePassword").popup("open");}
function ChangePasswordClick(){$('#lblChangePasswordError').html("");var sCurrentPassword=$('#currentPass').val();var sNewPassword=$('#newPass').val();var sConfirmPassword=$('#confirmNewPass').val();if(sCurrentPassword!=password){$('#lblChangePasswordError').html("Invalid Password");return;}
if(sNewPassword!=sConfirmPassword){$('#lblChangePasswordError').html("New passwords do not match");return;}
ChangePassword(sNewPassword);}
function ChangePassword(sNewPassword){$.mobile.loading('show',{text:"Changing Password...",textVisible:true,theme:"a"||$.mobile.loader.prototype.options.theme,textonly:false,html:""});var user=$.cookie("savedUser");var password=$.cookie("savedPassword");$.ajax({url:"/Controller/wsCmd.asmx/ChangePassword",cache:false,type:"POST",dataType:"json",data:"{_Email:'"+user+"', _Password:'"+password+"', _NewPassword:'"+sNewPassword+"'}",contentType:"application/json; charset=utf-8",success:function(msg){$.mobile.loading('hide');if(msg.d.ReturnCode==1){password=sNewPassword;$.cookie("savedPassword",sNewPassword,{expires:10000,path:'/'});$("#dlgChangePassword").popup("close");}
else{$('#lblChangePasswordError').html("Error: "+msg.d.Status);}},error:function(e){$.mobile.loading('hide');$('#lblChangePasswordError').val="Error: "+e.statusText.toString();return false;}});}
function Register(){$('#lblRegisterError').html('');var txtUser=$('#regUsername'),txtPassword=$('#regPassword'),txtFirstName=$('#regFirstName'),txtLastName=$('#regLastName'),txtPhone=$('#regPhone'),txtAddress=$('#regAddress'),txtCity=$('#regCity'),txtState=$('#regState'),txtZip=$('#regZip');if(txtUser.val()==''||txtPassword.val()==''){$('#lblRegisterError').html('Please enter a valid user and password');return;}
else if(txtAddress.val()==''||txtCity.val()==''||txtState.val()==''||txtZip.val()==''){$('#lblRegisterError').html('Please enter a valid address');return;}
else if(txtUser.hasClass('error')||txtPassword.hasClass('error')||txtAddress.hasClass('error')||txtState.hasClass('error')||txtCity.hasClass('error')||txtZip.hasClass('error')){$('#lblRegisterError').html('Please fix errors and try again');return;}
$.mobile.loading('show',{text:"Registering User...",textVisible:true,theme:"a"||$.mobile.loader.prototype.options.theme,textonly:false,html:""});var sNewUser=txtUser.val(),sNewPassword=txtPassword.val(),sFirstName=txtFirstName.val(),sLastName=txtLastName.val(),sPhone=txtPhone.val(),sAddress=txtAddress.val(),sCity=txtCity.val(),sState=txtState.val(),sZip=txtZip.val();var sRegisterData="{_Email:'"+sNewUser+"', _Password:'"+sNewPassword+"', _FirstName:'"+sFirstName+"', _LastName:'"+sLastName+"', _Phone:'"+sPhone
+"', _Address:'"+sAddress+"', _City:'"+sCity+"', _State:'"+sState+"', _Zip:'"+sZip+"'}";$.ajax({url:"/Controller/wsCmd.asmx/AddNewUser",cache:false,type:"POST",dataType:"json",data:sRegisterData,contentType:"application/json; charset=utf-8",success:function(msg){$.mobile.loading('hide');if(msg.d.ReturnCode==1){$.cookie("savedUser",sNewUser,{expires:10000,path:'/'});$.cookie("savedPassword",sNewPassword,{expires:10000,path:'/'});Controllers=null;RefreshData(true);}
else{$('#lblRegisterError').html("Error: "+msg.d.Status);}},error:function(e){$.mobile.loading('hide');$('#lblRegisterError').val="Error: "+e.statusText.toString();return false;}});}
function RefreshData(displayLoader){if(displayLoader){$.mobile.loading('show',{text:"Refreshing Data...",textVisible:true,theme:"a"||$.mobile.loader.prototype.options.theme,textonly:false,html:""});}
var user=$.cookie("savedUser");var password=$.cookie("savedPassword");var url="/Controller/wsCmd.asmx/ValidUser"+'?nocache='+new Date().getTime();var sRefreshData="{_Email:'"+user+"', _Password:'"+password+"'}";$.ajax({url:url,cache:false,type:"POST",dataType:"json",data:sRefreshData,contentType:"application/json; charset=utf-8",success:function(msg){if(displayLoader)
$.mobile.loading('hide');if(msg.d.ReturnCode==1){UserInfo=msg.d.Data;Controllers=msg.d.Data.Controllers;RefreshControllers();$.mobile.changePage("#pageMain");}
else{$('#lblLoginError').html("Error: "+msg.d.Status);}},error:function(e){if(displayLoader)
$.mobile.loading('hide');$('#lblLoginError').val="Error: "+e.statusText.toString();return false;}});}
function SendCommand(desc,cmd,showMainOnSuccess){if(Controller==null){return;}
Controller.CommandStatus="PENDING";Controller.CommandDescription=desc;$.mobile.loading('show',{text:"Sending Command...",textVisible:true,theme:"a"||$.mobile.loader.prototype.options.theme,textonly:false,html:""});var url="/Controller/wsCmd.asmx/SendCommand"+'?nocache='+new Date().getTime();var user=$.cookie("savedUser");var password=$.cookie("savedPassword");var sData="{ _Email:'"+user+"', _Password:'"+password+"', _ControllerID:'"+Controller.ControllerID.toString()+"', _Desc:'"+desc+"', _Cmd:'"+cmd+"'}";$.ajax({url:url,cache:false,type:"POST",dataType:"json",data:sData,contentType:"application/json; charset=utf-8",success:function(msg){$.mobile.loading('hide');nRefreshCountdown=5;nRefreshRetryCount=3;if(msg.d.ReturnCode!=1){Controller.CommandStatus="ERROR";Controller.CommandDescription=msg.d.Status;}
else{if(showMainOnSuccess)
$.mobile.changePage("#pageMain");}},error:function(e){$.mobile.loading('hide');Controller.CommandStatus="ERROR";Controller.CommandDescription=e.statusText.toString();return false;}});RefreshStatus();}
function GetAddressHTML(ui){var sAddressHTML='';sAddressHTML+=ui.City;if(sAddressHTML!='')
sAddressHTML+=', ';sAddressHTML+=ui.State;if(sAddressHTML!='')
sAddressHTML+=' ';sAddressHTML+=ui.Zip;if(ui.Address!=''&&sAddressHTML!='')
sAddressHTML=ui.Address+'<br />'+sAddressHTML;else
sAddressHTML+=ui.Address;return sAddressHTML;}